\section{Desarrollo} \label{sect:desarrollo}

Durante esta fase se implementó progresivamente la versión alfa del prototipo funcional. 

Se creó un componente móvil y un servidor para dar solución al problema de registro y control de gastos.
Para cumplir con los requerimientos del componente móvil, se desarrolló una aplicación para el sistema operativo Android, y se trabajó con el IDE Android Studio.

Se implementaron vistas para crear, editar y eliminar gastos. Para estos gastos, se debe guardar su monto, fecha, descripción, fotos de recibos y categoría a la que pertenecen. Posteriormente, se decidió extender la funcionalidad de creación de gastos para permitir también el manejo de ingresos. 

También se crearon vistas para el manejo de categorías, que incluyen la creación, edición y eliminación de las mismas.

Luego de la creación de las principales funcionalidades del sistema, mencionadas en los párrafos anteriores, se introdujo el concepto de "cuentas". Hasta el momento, los gastos estaban asociadosa una única cuenta por defecto. Por esta razón, también se creó una funcionalidad para agregar nuevas cuentas, y poder crear nuevos gastos dentro de dichas cuentas.

Como se explicó en la sección anterior, es necesario guardar toda esta información en la base de datos local de cada dispositivo. Para ello, se utilizó la librería SQLite.

Además, también se crearon dos vistas para reportes de gastos: una para reportes de balance general, y otra para reporte de gastos por categorías.
La vista de reporte de balance general muestra una lista de gastos e ingresos filtrados por fecha. La vista de reporte por categorías muestra una lista de categorías con la suma total de los gastos e ingresos de dichas categorías, filtradas por fecha.

Para mantener la lógica separada de la interfaz gráfica, se utilizó el patrón de arquitectura MVP o Modelo Vista Presentador, descrito en el capítulo 2. De esta manera, toda acción en la vista que requiera realizar operaciones sobre la base de datos, se realizó por medio de una capa intermedia: el presentador.

Por otra parte, se creó un servidor al que se pueda enviar información desde la aplicación móvil. 

Para permitir el acceso a la aplicación móvil, se creó un servicio web que permita hacer la autenticación del usuario. La aplicación envia al servidor un JSON con los datos del usuario (nombre de usuario y contraseña) por medio de una petición HTTP POST.

Se creó un servicio web que recibe un archivo PDF que contiene el reporte de gastos. Además del archivo, recibe la suma de gastos por cada categoría y el total de gastos. Estos datos se enviaron por medio de una petición HTTP Post Multipart, compuesta por un archivo y un JSON. Para la conversión de objetos de Java a JSON, y viceversa, se utilizó la librería GSON tanto en el servidor como en la aplicación móvil. Para persistir esta información, se utilizó Hibernate y MySQL como manejador de base de datos.

También se creó una aplicación web que permita aprobar o rechazar los reportes enviados al servidor.

El desarrollo del componente servidor se realizó con el IDE Eclipse. Se utilizó el \textit{framework} AppFuse, que integra a su vez otros \textit{frameworks} que facilitan el desarrollo web. Se utilizó Spring para la implementación de los servicios web que permiten recibir datos desde la aplicación móvil. Para crear la aplicación web, se utilizó Tapestry. Para el despliegue del servidor, se utilizó Maven y Jetty.

El proyecto se desarrolló bajo el marco de trabajo de \textit{Scrum}, descrito en el capitulo 1. Durante la ejecución de las iteraciones, se implementaron las funcionalidades planificadas, así como las pruebas necesarias para validarlas.

A continuación se presentarán las iteraciones (\textit{sprints}), durante las cuales se desarrollaron las funcionalidades descritas en los párrafos anteriores. Para cada iteración, se mencionarán sus objetivos, resultados y una breve descripción de las actividades realizadas.

\subsection{Sprint 1}

\subsubsection{Objetivos}
	\begin{itemize}
	\item Mostrar información del balance de una cuenta
	\item Permitir la creación de un nuevo gasto
	\end{itemize}

\subsubsection{Resultados}
\begin{itemize}
\item Se creó una vista para mostrar el total de ingresos,gastos y balance general de una cuenta.
\item Se creó una vista para permitir la creación de un nuevo gasto.
\end{itemize}

\subsubsection{Actividades}
En la primera parte del \textit{sprint} se implementó el modelo de datos del dispositivo móvil.

Se creó la vista principal de la aplicación móvil, donde se muestra el total de ingresos y el de gastos, así como el balance general. Para esto, fue necesario crear consultas a la base de datos que permitieran obtener el total de ingresos/gastos de una cuenta.  También se realizó una consulta que permite obtener el balance total de una cuenta.

Por otro lado se implementó una vista que permite crear un nuevo gasto, con su fecha, monto y descripción.

Como se expuso anteriormente, la comunicación entre el modelo y la vista se hace a través de una capa intermedia: el presentador. Por esta razón, también fue necesaria la creación de un presentador para cada vista que permita hacer consultas a la base de datos.

\subsection{Sprint 2}

\subsubsection{Objetivos}
\begin{itemize}
\item Mostrar la lista de categorías
\item Permitir la creación de un nuevo ingreso
\item Permitir guardar fotos de un $\entry$
\item Asociar un ingreso/gasto a una categoría
\end{itemize}

\subsubsection{Resultados}
\begin{itemize}
\item Se creó una vista para mostrar la lista de categorías a las que puede pertenecer un gasto.
\item Se adaptó y reutilizó la vista existente para crear un gasto para permitir la creación de un ingreso
\item Se agregó la funcionalidad para tomar fotos relacionadas a un ingreso/gasto
\item Se agregó la funcionalidad para poder asociar un ingreso/gasto a una categoría existente

\end{itemize}

\subsubsection{Actividades}

En este \textit{sprint} se creó la vista para mostrar las categorías presentes en el dispositivo.

Se creó una consulta para guardar en la base de datos una nueva categoría con su nombre y un ícono que la represente. Además, se creó una consulta para guardar en la base de datos una lista de categorías por defecto.

También se adaptó la vista existente para la creación de un gasto, de manera que se pueda reutilizar esta vista para la creación de un ingreso. 

Por otra parte, se implementó la funcionalidad para tomar y guardar fotos asociadas a un ingreso/gasto. Para esto se tuvo que crear un método que permita abrir la aplicación de la cámara del dispositivo desde la aplicación móvil. Luego, se tuvo que adaptar la vista para la creación de un ingreso/gasto para mostrar las miniaturas de las fotos tomadas. Se puso un límite por parte de la empresa para que el máximo de fotos que se puedan guardar por ingreso/gasto sean 3.

Por último, se modificó la vista para la creación de un ingreso/gasto para que se permitiera asociar una categoría. Se tenía como requerimiento guardar las cuatro categorías que se utilizaron más recientemente. Para esto, se tuvo que crear los métodos necesarios para persistir en el dispositivo móvil las categorias más recientes. Dado que esta información no tiene una estructura compleja, se decidió utilizar un objeto que provee la plataforma de Android, llamado \textit{SharedPreferences}, que permite guardar un conjunto de pares clave-valor. En este caso, se guardó una lista con las categorías más recientes.

\subsection{Sprint 3}
\subsubsection{Objetivos}
\begin{itemize}
\item Mostrar la lista de ingresos/gastos del mes actual
\item Mostrar los detalles de los ingresos/gastos existentes
\item Permitir editar y borrar un ingreso/gasto existente
\item Implementar una calculadora para guardar el monto de un ingreso/gasto
\end{itemize}

\subsubsection{Resultados}
\begin{itemize}
\item Se creó la vista para mostrar una lista con los gastos y otra con los ingresos del mes actual.
\item Se agregó la funcionalidad para ver los detalles de un ingreso/gasto ya existente, y poder editarlo
\item Se agregó la funcionalidad para eliminar ingresos/gastos
\item Se creó la interfaz para usar la calculadora que permita ingresar el monto de un ingreso/gasto
\end{itemize}

\subsubsection{Actividades}
En primer lugar, se adaptó la vista principal de la aplicación para mostrar el total de ingresos y gastos únicamente durante el mes actual. Para esto, se tuvo que modificar la consulta a la base de datos para obtener el total de ingresos/gastos dado un rango de fecha.

Se implementó la funcionalidad para navegar a la lista de ingresos o de gastos del mes desde la vista principal de la aplicación. Para esto, se creó una vista general donde se pueda mostrar una lista de ingresos/gastos, con su descripción (o categoría, en caso de que no tenga descripción), su fecha y su monto.

Por otra parte, se creó la funcionalidad para eliminar ingresos/gastos existentes desde la vista mencionada en el párrafo anterior.

También se creó la funcionalidad para editar un ingreso/gasto existente. Para esto no fue necesario crear una vista nueva, sino que se adaptó la que se tenía para la creación de un nuevo ingreso/gasto, de manera que se muestre la información relacionada adicho $entry$ (fecha, monto, categoría, descripción y fotos).

Por último, se tenía como requerimiento mostrar una calculadora para ingresar el monto de un ingreso/gasto, en lugar de un teclado numérico común. Por esta razón, se tuvo que modificar la vista de creación de un ingreso/gasto para incluir la nueva funcionalidad. 

Para este último requerimiento fue necesario crear un teclado virtual personalizado, pues el teclado numérico del dispositivo no incluye los operadores matemáticos básicos. Se creó el formato del teclado, el cual incluye las teclas presentes en una calculadora básica. También se tuvo que manejar el uso de las teclas: detectar qué tecla fue presionada y realizar una acción en base a esta. Se utilizó una librería para evaluar fórmulas dada una cadena de caracteres.

Para la calculadora, se tenía que mostrar el símbolo decimal de acuerdo con el país para el cual está configurado el teléfono, ya que en algunos países se usa la coma (,) como separador y en otros el punto (.). Por esta razón, se tuvo que obtener el país de configuración del teléfono para decidir qué símbolo decimal mostrar.



\subsection{Sprint 4}
\subsubsection{Objetivos}
\begin{itemize}
\item Permitir el manejo de nuevas cuentas
\end{itemize}

\subsubsection{Resultados}
\begin{itemize}

\item Se creó una vista para crear una nueva cuenta
\item Se implementó la funcionalidad para listar las cuentas del usuario 
\item Se implementó la funcionalidad para cambiar de cuenta
\item Se implementó la funcionalidad para editar el nombre de una cuenta existente
\item Se implementó la funcionalidad para eliminar cuentas existentes
\item Se implementó la funcionalidad para cambiar el estado de una cuenta: activa o archivada
\item Se implementó la funcionalidad para ver la lista de ingresos/gastos de una cuenta desde su creacion hasta la fecha actual

\end{itemize}

\subsubsection{Actividades}
En la ejecución de los \textit{sprints} anteriores se estuvo trabajando con una sola cuenta creada por defecto en la aplicación. Para este \textit{sprint}, se decidió agregar la funcionalidad para poder manejar nuevas cuentas. 

Para esto, se creó la vista que permite agregar una nueva cuenta, con su nombre y la moneda en la que van a estar sus ingresos/gastos.

Se creó una vista para mostrar la lista de cuentas guardadas. Se implementó la funcionalidad para cambiar el estado de una cuenta: activa o archivada. La lista de cuentas se muestra segun su estado, es decir, se muestra una lista para la lista de cuentas activas y una para las cuentas archivadas. 

Además, se implementaron las funcionalidades para editar el nombre de una cuenta y eliminar cuentas ya existentes.

También se creó la funcionalidad para cambiar la cuenta que se está mostrando actualmente en el dispositivo.

Por último, se adapto la vista existente para mostrar la lista de ingresos/gastos, de manera que se pueda mostrar todos los ingresos/gastos (en una misma lista) asociados a la cuenta que se muestra actualmente.




\subsection{Sprint 5}
\subsubsection{Objetivos}
\begin{itemize}
\item Permitir el manejo de las fotos de un ingreso/gasto
\item Permitir el manejo de las categorias
\end{itemize}

\subsubsection{Resultados}
\begin{itemize}
\item Se agregó la funcionalidad para ver las fotos de un ingreso/gasto
\item Se agregó la funcionalidad para borrar las fotos de un ingreso/gasto
\item Se agregó la funcionalidad para cambiar la ubicacion en el dispositivo de las fotos tomadas de un ingreso/gasto
\item Se agregó la funcionalidad para crear una categoría
\item Se agregó la funcionalidad para eliminar una categoría existente
\item Se agregó la funcionalidad para editar una categoría existentes
\end{itemize}

\subsubsection{Actividades}
La primera parte del \textit{sprint} se dedicó al manejo de las fotos. En primer lugar se creó la vista para poder ver en pantalla completa las fotos de un ingreso/gasto (esto se hace desde la vista de creación de un ingreso/gasto). También se implementó la funcionalidad para eliminar una foto.

Por otra parte, se creo la vista de configuraciones de la aplicación. En esta vista se agregó una opción para cambiar la ubicación en el dispositivo en la que se guardan los archivos de las fotos: memoria interna o memoria extraíble.

La egunda parte del \textit{sprint} se dedicó al manejo de las categorías. Se creó la interfaz para agregar una nueva categoría. Por último, se agregaron las funcionalidades para editar y eliminar categorias existentes.


\subsection{Sprint 6}
\subsubsection{Objetivos}
\begin{itemize}
\item Mostrar un reporte con la lista de ingresos/gastos asociados a una cuenta, en un rango de fecha dado
\item Mostrar un reporte con el balance total por categorías asociadas a una cuenta, en un rango de fecha dado
\item Permitir el envío de los reportes en un archivo PDF a otras personas

\end{itemize}

\subsubsection{Resultados}
\begin{itemize}
\item Se implementó la funcionalidad para listar los ingresos/gastos de una cuenta en el rango de fecha ingresado por el usuario
\item Se implementó la funcionalidad para listar el balance total de las categorías de una cuenta en el rango de fecha ingresado por el usuario
\item Se creó la funcionalidad para compartir el reporte con la lista de $\entries$,incluyendo las fotos, de la cuenta en el rango de fecha ingresado.
\item Se creó la funcionalidad para compartir el reporte con la lista de $\entries$, sin incluir las fotos, de la cuenta en el rango de fecha ingresado.
\item Se creó la funcionalidad para compartir el reporte con el balance total de las categorías de la cuenta en el rango de fecha ingresado.
\end{itemize}

\subsubsection{Actividades}
Este \textit{sprint} se dedicó exclusivamente al manejo de los reportes. Se tenía como requerimiento el manejo de dos tipos de reportes: reporte de balance general y reporte por categorías. Para la generación de ambos reportes, se puede especificar una cuenta y un rango de fechas. El reporte de balance general incluye la lista de todos los ingresos/gastos de la cuenta escogida, dentro del rango de fechas establecido. El reporte por categorías incluye únicamente el monto total de todos los ingresos/gastos (es decir, la suma de ingresos y gastos) divididos por categorías, de la cuenta y rango de fechas escogidos.

Se creó una vista para mostrar el reporte de balance general, que muestra una lista con los ingresos/gastos asociados, sus montos, fechas y descripción (o categoría, en caso de que la descripción sea nula). También se creó una vista para el reporte por categoría, donde se muestra una lista con con el nombre de cada categoría y la suma total de los ingresos y gastos correspondientes.

Luego, se creó la funcionalidad para generar un archivo PDF con la información de los reportes descritos anteriormente. Para esto se usó una librería que provee la plataforma de Android para la creación de archivos PDF.  

Se tenía como requerimiento que el usuario pueda escoger generar un archivo con el reporte de balance general incluyendo las fotos de los ingresos/gastos asociados, o sin incluirlas.

Luego se implementaron los métodos necesarios para crear un archivo PDF con el reporte del balance general. Esta funcionalidad luego se adaptó para permitir también la creación del reporte por categorías. Para la escritura del PDF, se tuvo que lidiar manualmente con la paginación. 

Por último, se creó la funcionalidad para compartir este archivo PDF con otras personas a través de otras aplicaciones instaladas en el dispositivo móvil. Dentro de estas aplicaciones se incluyen las de correo electrónico y mensajería móvil que soporten el envío de archivos.

Durante la creacion del archivo PDF se presentaron diferentes dificultades. En primer lugar, las librerias existentes en Java para generar archivos con dicha extension hacen uso de otras librerias, las cuales no son soportadas directamente en la plataforma de Android. Por esta razon, en un principio se decidio utilizar una adaptación de una librería de Java para poder ser utilizada en Android. Sin embargo, no se encontró documentación suficiente que permitiera entender su uso. Por esta razón, se decidió finalmente utilizar una librería nativa de Android que facilita la creación de archivos PDF, pero que sólo está disponible para versiones de Android a partir de la 4.4. Esta decisión se apoyó en el hecho de que aproximadamente el 78,5\% de los usuarios de Android utilizan una versión mayor o igual a 4.4 \cite{USG1}. 


\subsection{Sprint 7}
\subsubsection{Objetivos}
\begin{itemize}
\item Crear un servicio web para permitir la autenticación de un usuario
\item Crear un servicio web para recibir un reporte de gastos
\item Crear una aplicación web para mostrar los reportes recibidos
\item Permitir la aprobación o rechazo a través de la aplicación web de los reportes recibidos
\end{itemize}
\subsubsection{Resultados}
\begin{itemize}
\item Se diseñó e implementó el modelo de datos del servidor web
\item Se creó un servicio al cual la aplicación móvil se puede conectar para la autenticación de usuarios
\item Se creó un servicio a través del cual la aplicación móvil puede enviar reportes de gastos
\item Se creó una aplicación web, a través de la cual se permite la creación de nuevos usuarios y el manejo de reportes (listar, aprobar y rechazar reportes recibidos)
\end{itemize}

\subsubsection{Actividades}

En esta iteración se creó el servidor web al cual la aplicación móvil puede enviar peticiones.

En primer lugar, se creó el proyecto en AppFuse, con Tapestry como \textit{framework} para el desarrollo de la aplicación web. Utilizando Hibernate con MySQL, se crearon las tablas necesarias para implementar el modelo de datos mostrado en la figura 5.3.

Luego, se creó el servicio web para la autenticación de un usuario. 

Una vez creado, se implementó en la aplicación móvil una funcionalidad que permite iniciar sesión en el dispositivo. Para esto fue necesario crear una interfaz y los métodos necesarios para conectarse al servicio web para la autenticación del usuario.

Por otra parte, se creó un servicio web para recibir un reporte de gastos. Era necesario enviar tanto el archivo PDF con la información de los gastos, como un resumen de los totales por las categorías de interés para la empresa. Por esta razón, la comunicación entre la aplicación móvil y el servidor para el envío de reportes se hizo a través de una petición HTTP POST Multipart, que contiene el archivo PDF y un JSON con el resumen mencionado anteriormente.

También se creó un módulo para el envío de correos electrónicos. Esto se hizo para notificar al supervisor cuando un nuevo reporte llega al servidor, así como para enviar el archivo PDF adjunto al correo.

Luego de esto se creó la página web a través de la cual un supervisor puede ver la lista de reportes recibidos, así como aprobarlos o rechazarlos.

Para esto, se creó una vista que muestre la lista de reportes pendientes por reivisión (es decir, que aún no han sido aprobados ni rechazados). En esta vista se agregó una opción para poder descargar el archivo PDF de cada reporte, así como opciones para aprobarlo/rechazarlo.

Finalmente, se adaptó la vista mencionada anteriormente para poder mostrar una lista de los reportes ya revisados (es decir, que ya fueron aprobados o rechazados).
