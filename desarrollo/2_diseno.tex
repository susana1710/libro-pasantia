\section{Análisis y diseño de la solución} \label{sect:Diseno}

En esta fase tuvo lugar dos etapas fundamentales para el desarrollo: análisis del problema y diseño de la solución.

Para comprender mejor el problema presentado, se realizó una reunión con el dueño del producto (\textit{product owner}). En esta reunión se realizó el primer levantamiento y refinamiento de requerimientos. A partir de estos requerimientos, se diseñó una arquitectura base que diera solución al problema.

\subsection{Análisis del problema}

Se necesita una aplicación móvil que permita a los trabajadores de la compañía registrar gastos personales que posteriormente serán reembolsados. El reporte de estos gastos debe ser enviado a un servidor web como un archivo con formato PDF. También se requiere una aplicación web que permita aprobar o rechazar los reportes enviados.

La aplicación móvil debe permitir la creación de cuentas con diferentes monedas. Para cada una de estas cuentas, se pueden registrar gastos, a los cuales se puede asociar un monto, una fecha y una descripción. Además, se pueden tomar fotos de las facturas o recibos de dichos gastos.

Dado que la empresa realiza el reembolso de gastos en determinadas áreas, es necesario que estos gastos puedan asociarse a categorías que los identifiquen. Además, se debe permitir la creación de nuevas categorías en caso de que en algún momento la empresa decida incluir nuevos rubros.

También se quiere poder realizar consultas de los gastos registrados en un rango de fechas y generar un reporte de dichos gastos. Este reporte debe ser enviado a un servidor como un archivo de formato PDF.

Por último, se quiere que los supervisores de la compañía puedan tener acceso a los reportes de gastos mensuales de los trabajadores. Los supervisores deben poder aprobar o rechazar dichos reportes. Además, el archivo PDF de cada reporte debe ser guardado en el servidor.

\subsection{Diseño de la solución}

\subsubsection*{Arquitectura base}

Dados los requerimientos anteriores, se diseñó una arquitectura base para solucionar el problema. Se dividió el sistema según sus componentes: servidor web, dispositivos móviles y cliente web. Como se muestra en la figura 5.1, es una arquitectura cliente-servidor, donde el componente móvil y la aplicación web juegan el papel de cliente. En este caso, la aplicación móvil actúa como un cliente activo, pues es quien manejará los datos relevantes. El servidor solo recibirá esta información, sin poder modificarla. Esto corresponde a una arquitectura del tipo cliente activo-servidor pasivo, descrita en el capítulo 2.

\begin{figure}[ht]
  \centering
  \includegraphics[scale=0.4,type=png,ext=.png,read=.png]{imagenes/arquitectura_base}
  \caption{Arquitectura base de la solución}
  \label{fig:arquitecturaBase}
\end{figure}

Por medio de la aplicación móvil se podrá hacer el registro de los gastos personales. El servidor permitirá la revisión de los reportes de gastos, así como su aprobación o rechazo.

Toda la información relacionada a los gastos (fecha, monto, categorías, fotos) será creada y guardada localmente en cada dispositivo móvil. Cada dispositivo podrá enviar al servidor su reporte de gastos en forma de un archivo PDF. La comunicación entre la aplicación móvil y el servidor se hace por medio de servicios web que presta este último.

Estos reportes deberán ser guardados en la base de datos del servidor. Además, a través de una aplicación web, se podrá aprobar o rechazar los reportes recibidos.

\subsubsection*{Arquitectura de \textit{software}}

Para los componentes mencionados anteriormente, se definieron los patrones de arquitectura de \textit{software} sobre los cuales se crearon. Para el servidor se utilizó el patrón Modelo Vista Controlador (MVC) y para la aplicación móvil el Modelo Vista Presentador (MVP).

Tal como se explicó en el capítulo 2, MVC se usa para aislar la lógica de negocio de la interfaz de usuario. En este patrón, el modelo representa todos los datos de la aplicación y las reglas de negocio que se usan para manejar dichos datos. 

Como se muestra en la figura 5.2, el modelo incluye tanto los POJO's, DAO's como la base de datos. La vista corresponde a todo lo que son los elementos de la interfaz de usuario que, en este caso, son las vistas de la aplicación web. El controlador se encarga de manejar las acciones del usuario, y se comunica con el modelo o con la vista según sea necesario. El \textit{manager} definido en el capítulo 2 actúa como controlador.

\begin{figure}[ht]
  \centering
  \includegraphics[scale=0.6,type=png,ext=.png,read=.png]{imagenes/mvc}
  \caption{Modelo Vista Controlador}
  \label{fig:mvc}
\end{figure}

Por su parte, MVP es una derivación del patrón MVC, como se observa en la figura 5.3. El modelo incluye tanto la base de datos como los POJO's, los cuales fueron utilizados para establecer una correspondencia entre objetos de la aplicación con registros de la base de datos. La vista está formada por las actividades (\textit{activities}) definidos en el capítulo 2, y las interfaces de usuario.
 
En este caso, las acciones de usuario son recibidas por la vista. Luego, la vista se comunica con el presentador, que pide los datos al modelo. Al terminar de trabajo, el modelo notifica al presentador, y este último se encarga de modificar la vista a través de una interfaz.

\begin{figure}[ht]
  \centering
  \includegraphics[scale=0.6,type=png,ext=.png,read=.png]{imagenes/mvp}
  \caption{Modelo Vista Presentador}
  \label{fig:mvp}
\end{figure}

\subsubsection{Estructura de datos}

Para dar lugar al desarrollo del sistema, fue necesario diseñar un modelo de datos que permita mantener la información necesaria en el dispositivo móvil, y otro para mantener información en el servidor.

En la figura 5.4 se puede observar el diagrama de clases que representa el modelo de datos de la aplicación móvil. 

\begin{figure}[ht]
  \centering
  \includegraphics[scale=0.6,type=png,ext=.png,read=.png]{imagenes/class_diagram_mobile}
  \caption{Diagrama de clases de la aplicación móvil}
  \label{fig:classDiagramMobile}
\end{figure}

A continuación se describirán cada una de estas clases, así como sus atributos:

\begin{itemize}
	\item \textbf{\textit{Account}}: representa un conjunto de registros de movimientos de dinero. Almacena información de la moneda en la que estarán los montos de los registros asociados a la misma.
	\item \textbf{\textit{Entry}}: representa un registro dentro de una cuenta, y puede ser de dos tipos: ingreso o gasto. Almacena información del monto, fecha y descripción.
	\item \textbf{\textit{Category}}: representa las clases a las que puede pertenecer un \textit{entry}. Puede ser de dos tipos: categoría de ingresos o categoría de gastos. Almacena información general (nombre) y un ícono que la representa.
	\item \textbf{\textit{Photo}}: representa las fotos asociadas a un \textit{entry}. Almacena información del \textit{entry} al que pertenece, y la ruta del archivo dentro del dispositivo móvil.
\end{itemize}

Por otra parte, en la figura 5.5 se puede observar la estructura de datos del servidor. En este caso, se tienen dos clases: \textit{user} y \textit{report}.

\begin{figure}[ht]
  \centering
  \includegraphics[scale=0.6,type=png,ext=.png,read=.png]{imagenes/class_diagram_server}
  \caption{Diagrama de clases del servidor}
  \label{fig:classDiagramServer}
\end{figure}


\begin{itemize}
	\item \textbf{\textit{User}}: representa los usuarios registrados en el sistema. Almacena información del nombre completo, nombre de usuario, contraseña.
	\item \textbf{\textit{Report}}: representa un reporte enviado por un usuario, que contiene información de la suma total de \textit{entries} pertenecientes a ciertas categorías. Almacena información del monto total de entries de cuatro categorías: comida (\textit{food}), transporte (\textit{transportation}), salud (\textit{health}) y deporte (\textit{fitness}). Además, también almacena la fecha en que se envió el reporte, su estado (aprobado, rechazado o sin revisar) y la fecha en que fue revisado. Por último, tiene la ruta del archivo PDF correspondiente al reporte.
\end{itemize} 

Estos diagramas sirvieron como base para la creación del modelo tanto del servidor como de la aplicación móvil. 
%
%Como se observa, cada cuenta puede tener asociado múltiples gastos e ingresos. Para cada gasto/ingreso, se debe tener información de su monto, fecha y descripción. Estos también pueden estar asociados a alguna categoría, aunque no es un requisito. Además, se tiene una clase que representa las fotos que puede tener un gasto/ingreso. 
%
%
%Por otra parte, en la figura 5.3 se puede observar la estructura de datos del servidor. En este caso, se tiene información de los usuarios.
%
%Cada usuario tiene asociado un nombre de usuario y una contraseña. Con estos datos, la aplicación puede conectarse al servidor para la autenticación y el envío de reportes. 
%
%También se tienen los datos de los reportes recibidos, así como su estado: aprobado, rechazado o pendiente por revisión.
